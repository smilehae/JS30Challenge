<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Type Ahead ğŸ‘€</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <form class="search-form">
      <input type="text" class="search" placeholder="City or State" />
      <ul class="suggestions">
        <li>Filter for a city</li>
        <li>or a state</li>
      </ul>
    </form>
    <script>
      const endpoint =
        "https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json";
      //ë¯¸í•´ì˜ ì‹œë„
      //  /   JSONì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ì„œëŠ”, XMLHttpRequest(XHR) APIë¥¼ ì‚¬ìš©í•˜ë©´ ëœë‹¤.
      // const request = new XMLHttpRequest();
      // request.open("GET", endpoint);
      // request.responseType = "json";
      // request.send();
      // request.onload = function () {
      //   const cities = request.response;
      //   input.addEventListener("input", filterCities(cities, "New"));
      // };
      const cities = [];
      /////////////////////////////////////////////////////////
      //ë‹µ ì°¸ê³ 
      //XMLHttpReqestì˜ ëŒ€ì²´ì œì¸ fetch APIë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤.
      //jQueryì˜ ajaz()ì™€ ë‹¤ë¥¸ ì  : fetch()ì—ì„œ ë°˜í™˜ë˜ëŠ” promiseê°ì²´ëŠ” http errorì„ reject í•˜ì§€ ì•ŠìŒ. ëŒ€ì‹  ok ìƒíƒœê°€ falseë¡œ ëœ¬ë‹¤.
      //ë˜í•œ ì¿ í‚¤ë¥¼ ë³´ë‚´ê±°ë‚˜ ë°›ì§€ ì•ŠëŠ”ë‹¤.

      //fetch ì‚¬ìš© íë¦„ì€, íŠ¹ì • ì¸ìˆ˜ì˜ ê²½ë¡œì— ë”°ë¼ì„œ ê°€ì ¸ì˜¤ê³ , ì‘ë‹µì„ í¬í•¨í•˜ëŠ” ì•½ì†(response)ë¥¼ ë°˜í™˜í•˜ëŠ”ê²ƒ.
      fetch(endpoint)
        .then((blob) => blob.json())
        .then((data) => cities.push(...data));

      // const input = document.querySelector(".search");
      // input.addEventListener("input", function () {
      //   filterCities(cities, this.value);
      // });

      function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      function findMatches(wordToMatch, cities) {
        return cities.filter((place) => {
          // here we need to figure out if the city or state matches what was searched
          const regex = new RegExp(wordToMatch, "gi");
          //gë¼ëŠ”ê±´ ê°€ì¥ ì²˜ìŒì´ ë§¤ì¹­ëœë‹¤ê³  ë¦¬í„´í•˜ì§€ ë§ë¼ëŠ” ëœ».
          //iëŠ” insensitive. ì—¬ëŸ¬ê°œì¤‘ ì¼ë¶€ë§Œ ë§ì•„ë„ ë¨
          //ë”°ë¼ì„œ ì•„ë˜ì¤„ì€, wordToMatchë‘ ì¼ë¶€ë§Œ ë§ì•„ë„ trueë¥¼ ë°˜í™˜í•¨
          return place.city.match(regex) || place.state.match(regex);
        });
      }

      function displayMatches() {
        const matchArray = findMatches(this.value, cities);
        const suggestions = document.querySelector(".suggestions");

        const html = matchArray
          .map((place) => {
            const regex = new RegExp(this.value, "gi");
            //ì¼ì¹˜í•˜ëŠ” ë¬¸ìë¥¼ regexì— ì €ì¥í•˜ê³ , í•´ë‹¹ ë¶€ë¶„ì„ í•˜ì´ë¼ì´íŠ¸ë¡œ ë°”ê¿ˆ!
            //ì•„ì˜ˆ array.mapìœ¼ë¡œ ê°ì²´ì˜ ë‘ ìš”ì†Œë§Œ ë¹¼ì™€ì„œ stringìœ¼ë¡œ ë§Œë“œëŠ”ê²ƒ.
            const cityName = place.city.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            const stateName = place.state.replace(
              regex,
              `<span class="hl">${this.value}</span>`
            );
            return `
        <li>
          <span class="name">${cityName}, ${stateName}</span>
          <span class="population">${numberWithCommas(place.population)}</span>
        </li>
      `;
          })
          .join("");
        suggestions.innerHTML = html;
      }

      //ë¯¸í•´ ì‹œë„ : ì–´ë–»ê²Œë“  í•¨ìˆ˜ ë§Œë“¤ê³  filterê±¸ê³  stringì•ˆì— htmlë“¤ ë„£ê¸° ê¹Œì§„ ì˜ í–ˆëŠ”ë°, í•˜ì´ë¼ì´íŠ¸ë¥¼ ë„£ì§€ ëª»í–ˆë‹¤.
      function filterCities(cities, str) {
        const listContainer = document.querySelector(".suggestions");
        const cityArr = Array.from(cities).filter(function (city) {
          return city["city"].includes(str) || city["state"].includes(str);
        });
        const listTag = Array.from(document.querySelectorAll("li"));
        listTag.forEach((element) => {
          element.remove();
        });

        for (let i = 0; i < cityArr.length; i++) {
          const nameBlock = document.createElement("li");
          const indexCity = cityArr[i].city.indexOf(str);

          nameBlock.innerHTML = `${cityArr[i].city}, ${cityArr[i].state}
            <span class="population">
              ${numberWithCommas(cityArr[i].population)}
            </span>`;
          if (indexCity >= 0) {
            nameBlock.innerHTML =
              nameBlock.innerHTML.substring(0, indexCity) +
              `<span class='hl'>${str}</span>`;
          }
          listContainer.appendChild(nameBlock);
        }
      }

      const searchInput = document.querySelector(".search");
      searchInput.addEventListener("change", displayMatches);
      searchInput.addEventListener("keyup", displayMatches);
    </script>
  </body>
</html>
